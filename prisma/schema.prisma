generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
}

model Admin {
  id            String         @id @default(cuid())
  email         String         @unique
  password      String
  role          AdminRole      @default(ADMIN)
  isActive      Boolean   @default(true)
  refreshTokens RefreshToken[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String?
  adminId   String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  admin     Admin?   @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([adminId])
}

model Client {
  id                String    @id @default(cuid())
  name              String
  registrationEmail String? // Email from onboarding - used as default sender
  isApproved        Boolean   @default(false)
  isActive          Boolean   @default(true)
  plan              Plan      @relation(fields: [planId], references: [id])
  planId            String
  planStartDate     DateTime?
  planRenewalDate   DateTime?
  remainingMessages Int?

  // Mailgun Domain Configuration (CLIENT_SUPER_ADMIN configurable)
  mailgunDomain     String? // Client's verified Mailgun domain
  mailgunFromEmail  String? // Override sender email (defaults to registrationEmail)
  mailgunFromName   String? // Sender display name (defaults to registrationEmail if not set)
  mailgunVerified   Boolean   @default(false)
  mailgunVerifiedAt DateTime?

  users     User[]
  campaigns Campaign[]
  contacts  Contact[]
  groups    Group[]
  templates Template[]

  customFields        CustomField[]
  customFieldRequests CustomFieldRequest[]
  emailEvents         EmailEvent[]
  activityLogs        ClientActivityLog[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  suppressionLists    SuppressionList[]
}

enum UserRole {
  ADMIN
  SUPER_ADMIN
  CLIENT_SUPER_ADMIN
  CLIENT_ADMIN
  CLIENT_USER
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String
  role                UserRole             @default(CLIENT_USER)
  client              Client               @relation(fields: [clientId], references: [id])
  clientId            String
  customFieldRequests CustomFieldRequest[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  contacts            Contact[]
  campaigns           Campaign[]
  groups              Group[]
  templates           Template[]
  refreshTokens       RefreshToken[]
}

enum CampaignStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SENDING
  SENT
  STOPPED
}

enum RecurringFrequency {
  NONE
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
}

model Campaign {
  id                String         @id @default(cuid())
  name              String
  subject           String
  content           String
  status            CampaignStatus @default(DRAFT)
  isRecurring       Boolean        @default(false)
  recurringSchedule String? // Generated cron string (computed from other fields)

  // Enhanced recurring scheduling fields
  recurringFrequency  RecurringFrequency @default(NONE)
  recurringTime       String? // Time in HH:mm format (24-hour), defaults to 09:00 if not specified
  recurringTimezone   String? // IANA timezone (e.g., "Asia/Kolkata")
  recurringDaysOfWeek Int[] // 0-6 for Sunday-Saturday (for WEEKLY/BIWEEKLY)
  recurringDayOfMonth Int? // 1-31 (for MONTHLY)
  recurringStartDate  DateTime? // When recurring should start
  recurringEndDate    DateTime? // Optional end date for recurring

  groups      Group[]
  client      Client             @relation(fields: [clientId], references: [id])
  clientId    String
  emailEvents EmailEvent[]
  analytics   CampaignAnalytics?

  // Mailgun-specific fields
  mailgunMessageIds String? // JSON array of Mailgun message IDs
  mailgunTags       String[] // Tags for tracking
  sentAt            DateTime? // Timestamp when campaign was sent

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
}

model Contact {
  id                String                    @id @default(cuid())
  email             String
  firstName         String?
  lastName          String?
  client            Client                    @relation(fields: [clientId], references: [id])
  clientId          String
  createdById       String
  contactGroups     ContactGroup[]
  customFieldValues ContactCustomFieldValue[]
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  createdBy         User                      @relation(fields: [createdById], references: [id])
  nameValueId       String?                   @unique
  nameValue         ContactCustomFieldValue?  @relation("ContactNameIdentity", fields: [nameValueId], references: [id])

  @@unique([email, clientId])
}

model Group {
  id            String         @id @default(cuid())
  name          String
  campaigns     Campaign[]
  client        Client         @relation(fields: [clientId], references: [id])
  clientId      String
  contactGroups ContactGroup[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdById   String
  createdBy     User           @relation(fields: [createdById], references: [id])
}

model ContactGroup {
  contact    Contact  @relation(fields: [contactId], references: [id])
  contactId  String
  group      Group    @relation(fields: [groupId], references: [id])
  groupId    String
  assignedAt DateTime @default(now())

  @@id([contactId, groupId])
}

model Template {
  id          String   @id @default(cuid())
  name        String
  subject     String
  content     String
  client      Client   @relation(fields: [clientId], references: [id])
  clientId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
}

model Plan {
  id         String   @id @default(cuid())
  name       String
  price      Float
  emailLimit Int
  clients    Client[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// Enum for custom field types
enum CustomFieldType {
  TEXT
  NUMBER
  EMAIL
  PHONE
  DATE
  BOOLEAN
  URL
  TEXTAREA
  SELECT
  MULTISELECT
}

model CustomField {
  id              String                    @id @default(cuid())
  client          Client                    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        String
  name            String // Display name (e.g., "Company Name")
  fieldKey        String // Unique key for programmatic access (e.g., "company_name")
  type            CustomFieldType
  isRequired      Boolean                   @default(false)
  defaultValue    String? // Default value as string (parsed based on type)
  options         String? // JSON array for SELECT/MULTISELECT types
  validationRegex String? // Optional regex for validation
  helpText        String? // Helper text for users
  displayOrder    Int                       @default(0) // For UI ordering
  isActive        Boolean                   @default(true) // Soft delete support
  isNameField     Boolean                   @default(false) // Marks this field as the source of the Contact's display name
  values          ContactCustomFieldValue[]
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@unique([clientId, fieldKey])
  @@index([clientId, isActive])
}

model ContactCustomFieldValue {
  id              String      @id @default(cuid())
  contact         Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId       String
  customField     CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  customFieldId   String
  value           String // Stored as string, parsed based on field type
  contactIdentity Contact?    @relation("ContactNameIdentity")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([contactId, customFieldId])
  @@index([customFieldId])
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model CustomFieldRequest {
  id              String          @id @default(cuid())
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        String
  requestedBy     User            @relation(fields: [requestedById], references: [id])
  requestedById   String
  name            String
  fieldKey        String
  type            CustomFieldType
  isRequired      Boolean         @default(false)
  defaultValue    String?
  options         String?
  validationRegex String?
  helpText        String?
  status          RequestStatus   @default(PENDING)
  rejectionReason String?
  reviewedBy      String? // Admin/SuperAdmin ID who reviewed
  reviewedAt      DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([clientId, status])
}

model CampaignAnalytics {
  id                String   @id @default(cuid())
  campaign          Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId        String   @unique
  totalSent         Int      @default(0)
  totalDelivered    Int      @default(0)
  totalOpened       Int      @default(0)
  totalClicked      Int      @default(0)
  totalBounced      Int      @default(0)
  totalUnsubscribed Int      @default(0)
  totalComplaints   Int      @default(0)
  uniqueOpens       Int      @default(0)
  uniqueClicks      Int      @default(0)
  openRate          Float    @default(0)
  clickRate         Float    @default(0)
  bounceRate        Float    @default(0)
  lastUpdated       DateTime @updatedAt
  createdAt         DateTime @default(now())

  @@index([campaignId])
}

enum SuppressionType {
  BOUNCE
  UNSUBSCRIBE
  COMPLAINT
}

model SuppressionList {
  id        String          @id @default(cuid())
  email     String
  type      SuppressionType
  reason    String?
  client    Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId  String
  createdAt DateTime        @default(now())

  @@unique([email, type, clientId])
  @@index([clientId, type])
}

enum EmailEventType {
  SENT
  DELIVERED
  FAILED
  BOUNCED
  COMPLAINED
  OPENED
  CLICKED
}

model EmailEvent {
  id           String         @id @default(cuid())
  client       Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId     String
  campaign     Campaign?      @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignId   String?
  contactEmail String
  eventType    EmailEventType
  timestamp    DateTime       @default(now())
  mailgunId    String? // Mailgun message ID
  errorMessage String?
  metadata     String? // JSON for additional data

  @@index([clientId, eventType])
  @@index([campaignId])
  @@index([timestamp])
}

enum ActivityType {
  CLIENT_CREATED
  CLIENT_APPROVED
  CLIENT_REJECTED
  CLIENT_DEACTIVATED
  CLIENT_REACTIVATED
  PLAN_UPGRADED
  PLAN_DOWNGRADED
  CUSTOM_FIELD_CREATED
  CUSTOM_FIELD_UPDATED
  CUSTOM_FIELD_DELETED
  CONTACT_CREATED
  CONTACT_UPDATED
  CONTACT_DELETED
  CAMPAIGN_CREATED
  CAMPAIGN_SENT
  USER_CREATED
  USER_DELETED
  MAILGUN_DOMAIN_CONFIGURED
  MAILGUN_DOMAIN_UPDATED
  MAILGUN_DOMAIN_REMOVED
}

model ClientActivityLog {
  id              String       @id @default(cuid())
  client          Client?      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        String?
  activityType    ActivityType
  performedBy     String // User/Admin/SuperAdmin ID
  performedByRole String // Role of the performer
  description     String
  metadata        String? // JSON for additional context
  ipAddress       String?
  createdAt       DateTime     @default(now())

  @@index([clientId, createdAt])
  @@index([performedBy])
  @@index([activityType])
}
